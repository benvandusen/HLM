---
title: "R markdown test"
author: "BVD"
date: "9/18/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First we need to build the HLM models in R
Then do the AIC testing
Then do assumption checking
Then build descriptives for gain aggregated and disagregated and add the means to the descriptives table

---
title: "Equity analysis"
output: html_document
---

Load stuff (There are some packages that we don't need here, but I didn't clean them up. Sorry.)
```{r}
load("~/Box Sync/work/Research/R stuff/hmiout40")
library(lme4)
library(nlme)
library(mice)
library(mitml)
library(multcomp)
library(foreach)
library(dplyr)
```

Creating mitml and extra variables
```{r}
MIdata<-mids2mitml.list(hmi.out40)
MIdata <- within(MIdata,{
  G.pre <- clusterMeans(pre_scor,crse_id) # calculate group means
  stud_pre_cent <- pre_scor - G.pre          # center around group means
  class_pre_cent <- G.pre - mean(pre_scor)
  collabnla <- ifelse(colablrn==1,ifelse(used_las==0,1,0),0)
  gain <- pst_scor - pre_scor
})
```

Models
```{r}
modpost1<-pst_scor~1 + (1|crse_id)
modg1<-gain~1 + (1|crse_id)

modpost2<-(pst_scor~1 + stud_pre_cent+  race_urm + gen_urm + (1|crse_id))
modg2<-(gain~1 + stud_pre_cent+  race_urm + gen_urm + (1|crse_id))

modpost3<-(pst_scor~1 + stud_pre_cent*collabnla+ stud_pre_cent*used_las+ class_pre_cent + race_urm*used_las+ race_urm*collabnla + gen_urm*used_las + gen_urm*collabnla+ (1|crse_id))
modg3<-(gain~1 + stud_pre_cent*collabnla+ stud_pre_cent*used_las+ class_pre_cent + race_urm*used_las+ race_urm*collabnla + gen_urm*used_las + gen_urm*collabnla+ (1|crse_id))
```

Run models
```{r}
post1<-with(MIdata,{lmer(pst_scor~1 + (1|crse_id))})
gain1<-with(MIdata,{lmer(gain~1 + (1|crse_id))})

post2<-with(MIdata,{lmer(pst_scor~1 + stud_pre_cent+  race_urm + gen_urm + (1|crse_id))})
gain2<-with(MIdata,{lmer(gain~1 +stud_pre_cent+  race_urm + gen_urm+ (1|crse_id))})

post3<-with(MIdata,{lmer(pst_scor~1 + stud_pre_cent*collabnla+ stud_pre_cent*used_las+ class_pre_cent + race_urm*used_las+ race_urm*collabnla + gen_urm*used_las + gen_urm*collabnla + (1|crse_id))})
gain3<-with(MIdata,{lmer(gain~1 +stud_pre_cent*collabnla+ stud_pre_cent*used_las+ class_pre_cent + race_urm*used_las+ race_urm*collabnla + gen_urm*used_las + gen_urm*collabnla+ (1|crse_id))})
```

Model outputs
```{r}
testEstimates(post1, var.comp=TRUE)
testEstimates(gain1, var.comp=TRUE)

testEstimates(post2, var.comp=TRUE)
testEstimates(gain2, var.comp=TRUE)

testEstimates(post3, var.comp=TRUE)
testEstimates(gain3, var.comp=TRUE)
```

Creating groups for final model
```{r}
WM=c(1,0,0,0,0,0,0,0,0,0,0,0,0)
WMC=c(1,0,1,0,0,0,0,0,0,0,0,0,0)
WMLA=c(1,0,0,1,0,0,0,0,0,0,0,0,0)
BM=c(1,0,0,0,0,1,0,0,0,0,0,0,0)
BMC=c(1,0,1,0,0,1,0,0,0,0,1,0,0)
BMLA=c(1,0,0,1,0,1,0,0,0,1,0,0,0)
WF=c(1,0,0,0,0,0,1,0,0,0,0,0,0)
WFC=c(1,0,1,0,0,0,1,0,0,0,0,0,1)
WFLA=c(1,0,0,1,0,0,1,0,0,0,0,1,0)
BF=c(1,0,0,0,0,1,1,0,0,0,0,0,0)
BFC=c(1,0,1,0,0,1,1,0,0,0,1,0,1)
BFLA=c(1,0,0,1,0,1,1,0,0,1,0,1,0)

contrast.formulas <-rbind('White Male'=WM, 'White Male Collab'=WMC, 'White Male LA'=WMLA,
                          'Black Male'=BM, 'Black Male Collab'=BMC, 'Black Male LA'=BMLA,
                          'White Female'=WF,'White Female Collab'=WFC, 'White Female LA'=WFLA,
                          'Black Female'=BF,'Black Female Collab'=BFC, 'Black Female LA'=BFLA)
```

Confidence interval for MI attempt (This is where I'm stuck)
```{r}
get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(post3[[i]], linfct=contrast.formulas)) #specifically for post3
  covp3 <- vcov(glht(post3[[i]], linfct=contrast.formulas))
  data.frame(imp=i, 
             group=rownames(sx$linfct),
             d = sxp3$test$coefficients, 
             var.d = sxp3$test$sigma,
             cov = covp3)
}


p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + (1+1/max(imp)*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 

p3est

get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(gain3[[i]], linfct=contrast.formulas)) #specifically for post3
  covp3 <- vcov(glht(gain3[[i]], linfct=contrast.formulas))
  data.frame(imp=i, 
             group=rownames(sx$linfct),
             d = sxp3$test$coefficients, 
             var.d = sxp3$test$sigma,
             cov = covp3)
}


g3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + (1+1/max(imp)*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T),
                            cvwm = mean(cov.White.Male)) 

g3est
```

Ratios against majority
```{r}
ratmBF = g3est$Q[1]/g3est$Q[10]
ratmBFC = g3est$Q[2]/g3est$Q[11]
ratmBFL = g3est$Q[3]/g3est$Q[12]
ratmBM = g3est$Q[4]/g3est$Q[10]
ratmBMC = g3est$Q[5]/g3est$Q[11]
ratmBML = g3est$Q[6]/g3est$Q[12]
ratmWF = g3est$Q[7]/g3est$Q[10]
ratmWFC = g3est$Q[8]/g3est$Q[11]
ratmWFL = g3est$Q[9]/g3est$Q[12]


s.e.ratmBF = sqrt((ratmBF)^2*((g3est$T[1])/(g3est$Q[1]^2)+(g3est$T[10])/(g3est$Q[10]^2)-2*(g3est$cvwm[1]/((g3est$Q[1])*(g3est$Q[10])))))
s.e.ratmBFC = sqrt((ratmBFC)^2*((g3est$T[2])/(g3est$Q[2]^2)+(g3est$T[11])/(g3est$Q[11]^2)-2*(g3est$cvwm[2]/((g3est$Q[2])*(g3est$Q[11])))))
s.e.ratmBFL = sqrt((ratmBFL)^2*((g3est$T[3])/(g3est$Q[3]^2)+(g3est$T[12])/(g3est$Q[12]^2)-2*(g3est$cvwm[3]/((g3est$Q[3])*(g3est$Q[12])))))
s.e.ratmBM = sqrt((ratmBM)^2*((g3est$T[4])/(g3est$Q[4]^2)+(g3est$T[10])/(g3est$Q[10]^2)-2*(g3est$cvwm[4]/((g3est$Q[4])*(g3est$Q[10])))))
s.e.ratmBMC = sqrt((ratmBMC)^2*((g3est$T[5])/(g3est$Q[5]^2)+(g3est$T[11])/(g3est$Q[11]^2)-2*(g3est$cvwm[5]/((g3est$Q[5])*(g3est$Q[11])))))
s.e.ratmBML = sqrt((ratmBML)^2*((g3est$T[6])/(g3est$Q[6]^2)+(g3est$T[12])/(g3est$Q[12]^2)-2*(g3est$cvwm[6]/((g3est$Q[6])*(g3est$Q[12])))))
s.e.ratmWF = sqrt((ratmWF)^2*((g3est$T[7])/(g3est$Q[7]^2)+(g3est$T[10])/(g3est$Q[10]^2)-2*(g3est$cvwm[7]/((g3est$Q[7])*(g3est$Q[10])))))
s.e.ratmWFC = sqrt((ratmWFC)^2*((g3est$T[8])/(g3est$Q[8]^2)+(g3est$T[11])/(g3est$Q[11]^2)-2*(g3est$cvwm[8]/((g3est$Q[8])*(g3est$Q[11])))))
s.e.ratmWFL = sqrt((ratmWFL)^2*((g3est$T[9])/(g3est$Q[9]^2)+(g3est$T[12])/(g3est$Q[12]^2)-2*(g3est$cvwm[9]/((g3est$Q[9])*(g3est$Q[12])))))

s.e.ratmBF
s.e.ratmBFC
s.e.ratmBFL
s.e.ratmBM
s.e.ratmBMC
s.e.ratmBML
s.e.ratmWF
s.e.ratmWFC
s.e.ratmWFL
ratmBF
ratmBFC
ratmBFL 
ratmBM
ratmBMC
ratmBML
ratmWF
ratmWFC
ratmWFL
```
Ratios against self
```{r}
ratsBFC = g3est$Q[2]/g3est$Q[1]
ratsBFL = g3est$Q[3]/g3est$Q[1]
ratsBMC = g3est$Q[5]/g3est$Q[4]
ratsBML = g3est$Q[6]/g3est$Q[4]
ratsWFC = g3est$Q[8]/g3est$Q[7]
ratsWFL = g3est$Q[9]/g3est$Q[7]
ratsWMC = g3est$Q[11]/g3est$Q[10]
ratsWML = g3est$Q[12]/g3est$Q[10]

s.e.ratsBF = sqrt((ratsBF)^2*((g3est$T[2])/(g3est$Q[2]^2)+(g3est$T[1])/(g3est$Q[1]^2)-2*(g3est$cvwm[1]/((g3est$Q[1])*(g3est$Q[10]))))) #This doesn't work becuse I have to update the cvwm factor. 

ratsBFC
ratsBFL 
ratsBMC
ratsBML
ratsWFC
ratsWFL
ratsWMC
ratsWML
```

